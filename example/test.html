<html>

<head>
  <title>Async test</title>
  <script>
    (function() {
      var cache = {};

      function resolve(id, pwd) {
        var matches = id.match(/^((\.)?.*\/|)(.[^\.]*|)(\..*|)$/);
        return new URL(
          matches[1] + matches[3] + (matches[3] && (matches[4] || ".js")),
          matches[2] ? pwd : self.require.root
        );
      }

      function load(url, asyn) {
        var cached, request;
        cached = cache[url.href] = cache[url.href] || {
          module: undefined,
          promise: undefined,
          request: undefined,
          url: url
        };
        if (!cached.promise) {
          cached.promise = new Promise(function(res, rej) {
            request = cached.request = new XMLHttpRequest();
            request.addEventListener("load", function() {
              var done, error, loaded = 0, match, pattern;
              if (request.status >= 300) {
                error = new Error(url + " " + request.status + " " + request.statusText);
                rej(error);
                throw error;
              }
              if (asyn) {
                done = function() { if (--loaded <= 0) res(cached); };
                pattern = /require(?:\.resolve)?\((?:"((?:[^"\\]|\\.)+)"|'((?:[^'\\]|\\.)+)')\)/g;
                while((match = pattern.exec(request.responseText)) !== null) {
                  loaded++;
                  load(resolve(match[1]||match[2], url.href), true).then(done, done);
                }
              }
              if (loaded <= 0)
                res(cached);
            });
            request.addEventListener("error", function(evt) {
              rej(evt.details.error);
              throw evt.details.error;
            });
          });
        }
        // NOTE `request` is only defined if the module is requested for the first time.
        if (request || (!asyn && cached.request.status == 0)) {
          cached.request.abort();
          cached.request.open('GET', url.href, asyn);
          cached.request.send();
        }
        return asyn ? cached.promise : cached;
      }

      function evaluate(cached, parent) {
        var module;
        if (!cached.module) {
          module = cached.module = {
            children: new Array(),
						exports: Object.create(null),
            filename: cached.url.href,
            id: cached.url.pathname,
            loaded: false,
            parent: parent,
            require: undefined,
            uri: cached.url.href
          };
          module.require = factory(module);
          if (parent)
            parent.children.push(module);
          if (cached.request.getResponseHeader("Content-Type") == "application/json")
            module.exports = JSON.parse(cached.request.responseText);
          else
            (new Function(
							"exports,require,module,__filename,__dirname",
							cached.request.responseText + "\n//# sourceURL=" + cached.url.href
						))(module.exports, module.require, module, cached.url.href, cached.url.href.match(/.*\//)[0]);
          module.loaded = true;
        }
        return cached.module;
      }

      function factory(parent) {
        var require = function(id, asyn) {
          var pwd = parent ? parent.uri : location.href;
          return asyn ? new Promise(function(res, rej) {
            load(resolve(id, pwd), asyn)
              .then(function(cached) {
                res(evaluate(cached, parent).exports);
              }, rej);
          }) : evaluate(load(resolve(id, pwd), asyn), parent).exports;
        };
        require.resolve = function(id, asyn) {
          var pwd = parent ? parent.uri : location.href;
          return asyn ? new Promise(function(res, rej) {
            load(resolve(id, pwd), asyn)
              .then(function(cached) {
                res(cached.url.href);
              }, rej);
          }) : load(resolve(id, pwd), asyn).url.href;
        };
        return require;
      }

      (self.require = factory(null)).root = (new URL("./node_modules/", location.href)).href;
    })();
  </script>
</head>

<body>
  <script>
    /*
    var uri = require.resolve("relative/main");
    document.writeln(uri);
    //*/
    //*
    require.resolve("relative/main", true).then(console.log, console.error);
    //*/
    /*
    var mod = require("relative/main");
    document.writeln(mod.greet());
    //*/
    //*
    require("relative/main", true).then((mod) => {
      console.log(mod.greet());
    }, console.error);
    //*/
  </script>
</body>

</html>
